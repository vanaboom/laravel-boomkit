name: build-and-push-docker-matrix

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag to publish (e.g. 1.5)"
        required: false
        type: string
      variant:
        description: "Build only one variant (debian|debian-slim|alpine|alpine-slim)"
        required: false
        type: string

concurrency:
  group: docker-${{ github.sha }}   # <- dedupe per commit SHA
  cancel-in-progress: true

jobs:
  build:
    name: Build & Push (${{ matrix.id }})
    runs-on: ubuntu-latest

    # Matrix controls which folder to use and how to tag it
    strategy:
      fail-fast: false
      matrix:
        include:
          # NOTE: comments in English as requested
          - id: debian
            context: ./debian
            tag_suffix: debian
            push_latest: true
            platforms: linux/amd64
          - id: debian-slim
            context: ./debian-slim
            tag_suffix: debian-slim
            push_latest: false
            platforms: linux/amd64
          - id: alpine
            context: ./alpine
            tag_suffix: alpine
            push_latest: false
            platforms: linux/amd64
          - id: alpine-slim
            context: ./alpine-slim
            tag_suffix: alpine-slim
            push_latest: false
            platforms: linux/amd64

    env:
      IMAGE_NAME: vanaboom/laravel-boomkit

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Optional: filter matrix by dispatch input.variant
      - name: Skip if variant filter does not match
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.variant != '' && inputs.variant != matrix.id }}
        run: |
          echo "Skipping matrix '${{ matrix.id }}' because workflow_dispatch variant='${{ inputs.variant }}'"
          exit 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Compute tags
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          REPO="${IMAGE_NAME}"
          SUFFIX="${{ matrix.tag_suffix }}"
          PUSH_LATEST="${{ matrix.push_latest }}"

          # Pull context explicitly
          REF_TYPE="${{ github.ref_type }}"
          REF_NAME="${{ github.ref_name }}"
          EVENT="${{ github.event_name }}"
          INPUT_VER="${{ github.event.inputs.version || '' }}"

          echo "== Debug =="
          echo "EVENT=${EVENT}"
          echo "REF_TYPE=${REF_TYPE}"
          echo "REF_NAME=${REF_NAME}"
          echo "SUFFIX=${SUFFIX}"
          echo "PUSH_LATEST=${PUSH_LATEST}"
          echo "INPUT_VER=${INPUT_VER}"

          TAGS=()
          add_tag() { local t="$1"; [[ -n "$t" ]] && TAGS+=("${REPO}:${t}"); }

          # 1) Manual dispatch with version input
          if [[ -n "${INPUT_VER}" ]]; then
            V="${INPUT_VER}"
            add_tag "${V}-${SUFFIX}"
            add_tag "${SUFFIX}"
            if [[ "${PUSH_LATEST}" == "true" ]]; then add_tag "latest"; fi
            echo "Path: workflow_dispatch(version=${V})"
          fi

          # 2) Push tag: vMAJOR.MINOR or vMAJOR.MINOR.PATCH
          if [[ "${REF_TYPE}" == "tag" ]]; then
            VER_STRIPPED="${REF_NAME#v}"   # remove leading 'v'
            if [[ "${VER_STRIPPED}" =~ ^[0-9]+(\.[0-9]+){1,2}$ ]]; then
              VER="${VER_STRIPPED}"
              add_tag "${VER}-${SUFFIX}"
              add_tag "${SUFFIX}"
              if [[ "${PUSH_LATEST}" == "true" ]]; then add_tag "latest"; fi
              echo "Path: push tag (VER=${VER})"
            else
              echo "Tag '${REF_NAME}' does not look like a version, skipping versioned tags."
            fi
          fi

          # 3) (optional) Push to main â†’ rolling only (kept for manual runs)
          if [[ "${REF_TYPE}" == "branch" && "${REF_NAME}" == "main" ]]; then
            add_tag "${SUFFIX}"
            if [[ "${PUSH_LATEST}" == "true" ]]; then add_tag "latest"; fi
            echo "Path: push main (rolling)"
          fi

          # Fallback: at least the variant alias
          if [[ "${#TAGS[@]}" -eq 0 ]]; then
            add_tag "${SUFFIX}"
            if [[ "${PUSH_LATEST}" == "true" ]]; then add_tag "latest"; fi
            echo "Path: fallback (alias only)"
          fi

          echo "Computed tags:"
          printf ' - %s\n' "${TAGS[@]}"

          printf 'tags=%s\n' "$(IFS=, ; echo "${TAGS[*]}")" >> "$GITHUB_OUTPUT"

      - name: Build & Push (${{ matrix.id }})
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          push: true
          platforms: ${{ matrix.platforms }}
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache-${{ matrix.id }}
          cache-to: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache-${{ matrix.id }},mode=max
